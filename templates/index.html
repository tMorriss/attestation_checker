<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attestation Checker</title>
    <link rel="shortcut icon" href="{{url_for('static', filename = 'favicon.ico')}}">
    <link rel="stylesheet" href="{{url_for('static', filename = 'style.css')}}">
    <script src="{{url_for('static', filename = 'jquery-3.5.1.min.js')}}"></script>
    <script>
        var isUVPAA = false;
        let successCode = '2000';
        var registeredKeys = [];
        const conditionalUiController = new AbortController();

        window.onload = function () {
            // FIDO対応か確認
            PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable(
            ).then((result) => {
                if (result) {
                    isUVPAA = true;
                    $('#isUVPAAStatus').text('TRUE').addClass('text-success').removeClass('text-error');
                } else {
                    $('#isUVPAAStatus').text('FALSE').addClass('text-error').removeClass('text-success');
                }
            });
            // Conditional UI対応判定
            if (PublicKeyCredential.isConditionalMediationAvailable) {
                PublicKeyCredential.isConditionalMediationAvailable()
                    .then((result) => {
                        if (result) {
                            $('#isCMAStatus').text('TRUE').addClass('text-success').removeClass('text-error');
                            authenticate(true);
                        } else {
                            $('#isCMAStatus').text('FALSE').addClass('text-error').removeClass('text-success');
                        }
                    });
            }
            if (PublicKeyCredential.getClientCapabilities) {
                PublicKeyCredential.getClientCapabilities()
                    .then((result) => {
                        $("#tblClientCapabilities tbody tr").remove();
                        $("#tblClientCapabilities").append(`<tr><th>capability</th><th>result</th></tr>`);
                        Object.keys(result).forEach((e) => {
                            let value = result[e];
                            let className = '';
                            if (value === true) {
                                className = 'text-success';
                                value = 'TRUE';
                            } else if (value === false) {
                                className = 'text-error';
                                value = 'FALSE';
                            }
                            $("#tblClientCapabilities").append(`<tr><td>${e}</td><td><span class="${className}">${value}</span></td></tr>`);
                        })
                        $('#isCCStatus').text('Done').addClass('status-indicator');
                    }).catch((e) => {
                        $('#isCCStatus').text(e).addClass('text-error');
                    });
            } else {
                $('#isCCStatus').text("not supported").addClass('text-muted');
            }
        }

        function base64UrlToBuffer(base64) {
            let binary = atob(base64.replace(/-/g, '+').replace(/_/g, '/') + "=".repeat(4 - base64.length % 4));
            let len = binary.length;
            let bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes;
        }

        function bufferToBase64Url(buffer) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        function bufferToString(buffer) {
            return String.fromCharCode.apply(null, new Uint8Array(buffer));
        }

        function digObject(obj) {
            const result = {}
            for (const key in obj) {
                if (obj[key] === null) {
                    result[key] = null
                } else if (obj[key] instanceof ArrayBuffer) {
                    result[key] = bufferToBase64Url(obj[key])
                } else if (typeof obj[key] === 'object') {
                    result[key] = digObject(obj[key])
                } else if (typeof obj[key] === 'function') {
                    try {
                        result[key] = obj[key]()
                    } catch (e) {
                        result[key] = `FunctionError: ${e.message}`;
                    }
                } else {
                    result[key] = obj[key]
                }
            }
            return result
        }

        function attestation_options(options) {
            return $.post({
                url: "/attestation/options",
                data: JSON.stringify(options),
                contentType: 'application/json'
            })
        }

        function attestation_result(rawCredential) {
            const credential = digObject(rawCredential)
            try {
                credential.response.transports = rawCredential.response.getTransports();
            } catch (TypeError) {
            }
            return $.post({
                url: "/attestation/result",
                data: JSON.stringify(credential),
                contentType: 'application/json'
            })
        }

        function assertion_options(options) {
            return $.post({
                url: "/assertion/options",
                contentType: 'application/json'
            })
        }

        function assertion_result(rawCredential) {
            const credential = digObject(rawCredential)
            return $.post({
                url: "/assertion/result",
                data: JSON.stringify(credential),
                contentType: 'application/json'
            })
        }

        function register() {
            $('#dumpOptions').text("");
            $('#resultMsg').text("");
            conditionalUiController.abort('AnotherSessionRequested'); //前の処理をキャンセル
            // optionsリクエスト
            attestation_options().then((response) => {
                // レスポンスをデコード
                options = JSON.parse(response);
                if (options.statusCode != successCode) {
                    $('#resultMsg').text(response);
                    return
                }
                delete options.statusCode;
                // 指定したオプションを追加（登録用）
                if ($('input[name=reg-authenticatorSelection-enable]').prop('checked')) {
                    options.authenticatorSelection = {};
                    if ($('input[name=reg-authenticatorAttachment-enable]').prop('checked')) {
                        options.authenticatorSelection.authenticatorAttachment = $('[name=reg-authenticatorAttachment]').val();
                    }
                    if ($('input[name=reg-requireResidentKey-enable]').prop('checked')) {
                        options.authenticatorSelection.requireResidentKey = $('[name=reg-requireResidentKey]').val() == 'true';
                    }
                    if ($('input[name=reg-residentKey-enable]').prop('checked')) {
                        options.authenticatorSelection.residentKey = $('[name=reg-residentKey]').val();
                    }
                    if ($('input[name=reg-userVerification-enable]').prop('checked')) {
                        options.authenticatorSelection.userVerification = $('[name=reg-userVerification]').val();
                    }
                }
                if ($('input[name=reg-attestation-enable]').prop('checked')) {
                    options.attestation = $('[name=reg-attestation]').val();
                }
                const dumpMsg = JSON.stringify(options, null, "   ");
                const dumpHtmlString = dumpMsg.replace(/ /g, "&ensp;").replace(/\n/g, "<br>");
                $('#dumpOptions').html(dumpHtmlString);
                // 各種デコード
                options.user.id = new TextEncoder().encode(options.user.id);
                options.challenge = new TextEncoder().encode(options.challenge);
                for (let i = 0; i < options.excludeCredentials.length; i++) {
                    options.excludeCredentials[i].id = base64UrlToBuffer(options.excludeCredentials[i].id)
                }
                // 鍵生成
                return navigator.credentials.create({ publicKey: options });
            }).then((credential) => {
                // resultリクエスト
                return attestation_result(credential);
            }).catch(e => {
                if (e.name == "InvalidStateError" && e.message == "The user attempted to register an authenticator that contains one of the credentials already registered with the relying party.") {
                    $('#resultMsg').text("二重登録エラー");
                    return;
                } else {
                    $('#resultMsg').text(e);
                }
            }).then((response) => {
                responseJson = JSON.parse(response)
                if (responseJson.statusCode != successCode) {
                    $('#resultMsg').text(response);
                    return
                }
                registeredKeys.push({
                    credential_id: responseJson.credential_id,
                    transports: responseJson.transports
                })
                $("#tblCredentials").append(`<tr><td>${responseJson.credential_id}</td><td>${responseJson.transports}</td></tr>`);
                const resultMsg = JSON.stringify(responseJson.attestation, null, "   ");
                const resultHtmlString = resultMsg.replace(/ /g, "&ensp;").replace(/\n/g, "<br>");
                $('#resultMsg').html(resultHtmlString);
            });
        }

        function authenticate(isConditionalUI) {
            $('#dumpOptions').text("");
            $('#resultMsg').text("");
            console.log("fire authenticate, conditional ui = " + isConditionalUI);
            if (!isConditionalUI) {
                conditionalUiController.abort('AnotherSessionRequested'); //前の処理をキャンセル
            }
            // optionsリクエスト
            assertion_options().then((response) => {
                // レスポンスをデコード
                options = JSON.parse(response);
                if (options.statusCode != successCode) {
                    $('#resultMsg').text(response);
                    return;
                }
                options.allowCredentials = [];
                registeredKeys.forEach(key => {
                    options.allowCredentials.push({
                        type: "public-key",
                        id: key.credential_id, // dump用に1回stringで置く
                        transports: key.transports.split(',')
                    })
                })
                delete options.statusCode;
                // 指定したオプションを追加（認証用）
                if ($('input[name=auth-userVerification-enable]').prop('checked')) {
                    options.userVerification = $('[name=auth-userVerification]').val();
                }
                const dumpMsg = JSON.stringify(options, null, "   ");
                const dumpHtmlString = dumpMsg.replace(/ /g, "&ensp;").replace(/\n/g, "<br>");
                $('#dumpOptions').html(dumpHtmlString);

                options.challenge = new TextEncoder().encode(options.challenge);
                for (let i = 0; i < options.allowCredentials.length; i++) {
                    options.allowCredentials[i].id = base64UrlToBuffer(options.allowCredentials[i].id);
                }

                console.log("options");
                console.log(options);

                // 生体認証
                if (isConditionalUI) {
                    return navigator.credentials.get({
                        mediation: 'conditional',
                        publicKey: options,
                        signal: conditionalUiController.signal
                    });
                } else {
                    return navigator.credentials.get({ publicKey: options });
                }
            }).then((credential) => {
                console.log('assertion_dump')
                console.log(credential)
                // resultリクエスト
                return assertion_result(credential);
            }).then((response) => {
                responseJson = JSON.parse(response)
                if (responseJson.statusCode != successCode) {
                    $('#resultMsg').text(response);
                    return
                }
                const resultMsg = JSON.stringify(responseJson.assertion, null, "   ");
                const resultHtmlString = resultMsg.replace(/ /g, "&ensp;").replace(/\n/g, "<br>");
                $('#resultMsg').html(resultHtmlString);
            }).catch(e => {
                $('#resultMsg').text(e);
            });
        }

    </script>
</head>

<body>
    <div class="container">
        <H1>Attestation Checker</H1>

        <div class="card">
            <H2>FIDO関係対応状況</H2>
            <table class="status-table">
                <tr>
                    <th>Check Item</th>
                    <th>Status</th>
                </tr>
                <tr>
                    <td>isUserVerifyingPlatformAuthenticatorAvailable</td>
                    <td><span id="isUVPAAStatus" class="status-indicator">Checking...</span></td>
                </tr>
                <tr>
                    <td>isConditionalMediationAvailable</td>
                    <td><span id="isCMAStatus" class="status-indicator">Checking...</span></td>
                </tr>
                <tr>
                    <td>getClientCapabilities</td>
                    <td><span id="isCCStatus" class="status-indicator">Checking...</span></td>
                </tr>
            </table>

            <H3>Client Capabilities Details</H3>
            <table id="tblClientCapabilities">
                <!-- Filled by JS -->
            </table>
        </div>

        <div class="card">
            <H2>FIDOテスト</H2>
            <H3>登録オプション (Registration Options for create)</H3>
            <div id="registration_option_picker" class="options-grid">
                <div class="editor indent-0 form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="reg-authenticatorSelection-enable" name="reg-authenticatorSelection-enable"
                            checked>
                        <label for="reg-authenticatorSelection-enable">authenticatorSelection</label>
                    </div>
                </div>
                <div class="editor indent-1 form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="reg-authenticatorAttachment-enable" name="reg-authenticatorAttachment-enable"
                            checked>
                        <label for="reg-authenticatorAttachment-enable">authenticatorAttachment</label>
                    </div>
                    <select name="reg-authenticatorAttachment">
                        <option value="platform">platform</option>
                        <option value="cross-platform">cross-platform</option>
                    </select>
                </div>
                <div class="editor indent-1 form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="reg-requireResidentKey-enable" name="reg-requireResidentKey-enable" checked>
                        <label for="reg-requireResidentKey-enable">requireResidentKey</label>
                    </div>
                    <select name="reg-requireResidentKey">
                        <option value="true">true</option>
                        <option value="false">false</option>
                    </select>
                </div>
                <div class="editor indent-1 form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="reg-residentKey-enable" name="reg-residentKey-enable">
                        <label for="reg-residentKey-enable">residentKey</label>
                    </div>
                    <select name="reg-residentKey">
                        <option value="required">required</option>
                        <option value="preferred">preferred</option>
                        <option value="discouraged">discouraged</option>
                    </select>
                </div>
                <div class="editor indent-1 form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="reg-userVerification-enable" name="reg-userVerification-enable" checked>
                        <label for="reg-userVerification-enable">userVerification</label>
                    </div>
                    <select name="reg-userVerification">
                        <option value="required">required</option>
                        <option value="preferred">preferred</option>
                        <option value="discouraged">discouraged</option>
                    </select>
                </div>
                <div class="editor indent-0 form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="reg-attestation-enable" name="reg-attestation-enable" checked>
                        <label for="reg-attestation-enable">attestation</label>
                    </div>
                    <select name="reg-attestation">
                        <option value="direct">direct</option>
                        <option value="indirect">indirect</option>
                        <option value="enterprise">enterprise</option>
                        <option value="none">none</option>
                    </select>
                </div>
            </div>

            <H3>認証オプション (Authentication Options for get)</H3>
            <div id="authentication_option_picker" class="options-grid">
                <div class="editor indent-0 form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="auth-userVerification-enable" name="auth-userVerification-enable" checked>
                        <label for="auth-userVerification-enable">userVerification</label>
                    </div>
                    <select name="auth-userVerification">
                        <option value="required">required</option>
                        <option value="preferred">preferred</option>
                        <option value="discouraged">discouraged</option>
                    </select>
                </div>
            </div>

            <H3>Registered Credentials</H3>
            <table id="tblCredentials">
                <tr>
                    <th>credential_id</th>
                    <th>transports</th>
                </tr>
            </table>

            <div class="form-group" style="margin-top: 2rem;">
                <label for="username">Username (for Conditional UI)</label>
                <input type="username" id="username" placeholder="Enter username" autocomplete="webauthn" />
            </div>

            <div class="btn-group">
                <button onclick="register()">登録！(Register)</button>
                <button onclick="authenticate(false)">認証！(Authenticate)</button>
            </div>

            <details>
                <summary>認証機に投げたoptions (Options sent to authenticator)</summary>
                <div id="dumpOptions"></div>
            </details>
            <div id="resultMsg"></div>
        </div>

        <div class="card">
            <H2>ブラウザ情報 (Browser Info)</H2>
            <table id="tblBrowserInfo">
                <tr>
                    <th>User Agent</th>
                    <td>{{user_agent}}</td>
                </tr>
                <tr>
                    <th>Sec-CH-UA</th>
                    <td>{{sec_ch_ua}}</td>
                </tr>
                <tr>
                    <th>Sec-CH-UA-Arch</th>
                    <td>{{sec_ch_ua_arch}}</td>
                </tr>
                <tr>
                    <th>Sec-CH-UA-Bitness</th>
                    <td>{{sec_ch_ua_bitness}}</td>
                </tr>
                <tr>
                    <th>Sec-CH-UA-Full-Version-List</th>
                    <td>{{sec_ch_ua_full_version_list}}</td>
                </tr>
                <tr>
                    <th>Sec-CH-UA-Full-Version</th>
                    <td>{{sec_ch_ua_full_version}}</td>
                </tr>
                <tr>
                    <th>Sec-CH-UA-Mobile</th>
                    <td>{{sec_ch_ua_mobile}}</td>
                </tr>
                <tr>
                    <th>Sec-CH-UA-Model</th>
                    <td>{{sec_ch_ua_model}}</td>
                </tr>
                <tr>
                    <th>Sec-CH-UA-Platform</th>
                    <td>{{sec_ch_ua_platform}}</td>
                </tr>
                <tr>
                    <th>Sec-CH-UA-Platform-Version</th>
                    <td>{{sec_ch_ua_platform_version}}</td>
                </tr>
                <tr>
                    <th>Sec-CH-Prefers-Reduced-Motion</th>
                    <td>{{sec_ch_prefers_reduced_motion}}</td>
                </tr>
                <tr>
                    <th>Sec-CH-Prefers-Color-Scheme</th>
                    <td>{{sec_ch_prefers_color_scheme}}</td>
                </tr>
                <tr>
                    <th>Device-Memory</th>
                    <td>{{device_memory}}</td>
                </tr>
                <tr>
                    <th>DPR</th>
                    <td>{{dpr}}</td>
                </tr>
                <tr>
                    <th>Width</th>
                    <td>{{width}}</td>
                </tr>
                <tr>
                    <th>Viewport-Width</th>
                    <td>{{viewport_width}}</td>
                </tr>
                <tr>
                    <th>Save-Data</th>
                    <td>{{save_data}}</td>
                </tr>
                <tr>
                    <th>Downlink</th>
                    <td>{{downlink}}</td>
                </tr>
                <tr>
                    <th>ECT</th>
                    <td>{{ect}}</td>
                </tr>
                <tr>
                    <th>RTT</th>
                    <td>{{rtt}}</td>
                </tr>
            </table>
        </div>
    </div>
</body>

</html>